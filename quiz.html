<!DOCTYPE html>
<html>

<head>
    <title>AI Generated Quiz</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='quiz.css') }}">
    <style>
        .correct {
            color: green;
            font-weight: bold;
        }

        .wrong {
            color: red;
            font-weight: bold;
        }

        .start-btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: #ffffff;
            border: none;
            padding: 12px 28px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 18px rgba(79, 70, 229, 0.35);
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.5);
            opacity: 0.95;
        }

        .start-btn:active {
            transform: scale(0.97);
        }
    </style>
</head>

<body>

    <div class="quiz-box">
        <h2>AI Generated Quiz</h2>

        <label>Subject</label>
        <input type="text" id="subject" readonly>
         <!-- Populate subject from URL query parameter -->
        <!-- const urlParams = new URLSearchParams(window.location.search); -->
        <!-- const subjectParam = urlParams.get("subject") || "DSA"; -->
        <!-- document.getElementById("subject").value = subjectParam; -->


        <label>Topic</label>
        <input type="text" id="topic" placeholder="Enter topic (eg: Arrays)">

        <label>Difficulty</label>
        <select id="difficulty">
            <option value="Easy">Easy</option>
            <option value="Medium">Medium</option>
            <option value="Hard">Hard</option>
        </select>

        <!-- ✅ ID ADDED -->
        <button id="generateBtn" class="start-btn" onclick="generateQuiz()">
            Generate Quiz
        </button>

        <p id="loadingText" style="display:none; font-weight:bold; color:#2563eb;">
            Generating quiz... please wait ⏳
        </p>

        <p><b>Time:</b> <span id="timer">0</span> seconds</p>

        <div id="quiz-area"></div>
    </div>

    <script>
        // Get subject from URL query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const subjectParam = urlParams.get("subject") || "DSA";
        document.getElementById("subject").value = subjectParam;
    </script>

    <script>
        let correctAnswers = [];
        let startTime = null;
        let timerInterval = null;

        function generateQuiz() {
            const subject = document.getElementById("subject").value;
            const topic = document.getElementById("topic").value;
            const difficulty = document.getElementById("difficulty").value;

            if (!topic) {
                alert("Please enter a topic");
                return;
            }

            // ✅ SHOW LOADING IMMEDIATELY
            document.getElementById("loadingText").style.display = "block";
            document.getElementById("generateBtn").disabled = true;
            document.getElementById("quiz-area").innerHTML = "";

            clearInterval(timerInterval);
            startTime = Date.now();
            document.getElementById("timer").innerText = "0";

            timerInterval = setInterval(() => {
                document.getElementById("timer").innerText =
                    Math.floor((Date.now() - startTime) / 1000);
            }, 1000);

            fetch("/generate-quiz", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ subject, topic, difficulty })
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("loadingText").style.display = "none";
                    document.getElementById("generateBtn").disabled = false;

                    let questions = Array.isArray(data) ? data : data.quiz;
                    if (!questions || !questions.length) {
                        alert("Quiz generation failed");
                        return;
                    }

                    correctAnswers = [];
                    let html = "";

                    questions.forEach((q, index) => {
                        let correct = q.answer.trim().toLowerCase();
                        let matched = q.options.find(
                            opt => opt.trim().toLowerCase() === correct
                        ) || q.options[0];

                        correctAnswers.push(matched);

                        html += `<p><b>Q${index + 1}. ${q.question}</b></p>`;
                        q.options.forEach(opt => {
                            html += `
                                <label>
                                    <input type="radio" name="q${index}" value="${opt}">
                                    ${opt}
                                </label><br>
                            `;
                        });
                        html += "<hr>";
                    });

                    html += `<button onclick="submitQuiz()">Submit Quiz</button>`;
                    html += `<h3 id="result"></h3>`;

                    document.getElementById("quiz-area").innerHTML = html;
                });
        }

        function submitQuiz() {
            clearInterval(timerInterval);

            let score = 0;
            const timeTaken = Math.floor((Date.now() - startTime) / 1000);

            correctAnswers.forEach((correct, index) => {
                const options = document.getElementsByName(`q${index}`);
                let selected = null;

                for (let opt of options) {
                    if (opt.checked) selected = opt.value;
                }

                for (let opt of options) {
                    const label = opt.parentElement;
                    label.classList.remove("correct", "wrong");

                    if (opt.value === correct) label.classList.add("correct");
                    if (opt.checked && opt.value !== correct) label.classList.add("wrong");
                }

                if (selected === correct) score++;
            });

            document.getElementById("result").innerText =
                `You scored ${score} / ${correctAnswers.length}`;

            fetch("/save-result", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    subject: document.getElementById("subject").value,
                    topic: document.getElementById("topic").value,
                    score: score,
                    total: correctAnswers.length,
                    timeTaken: timeTaken
                })
            }).then(() => {
                // ⏳ student sees answers before redirect
                setTimeout(() => {
                    window.location.href = "/dashboard";
                }, 60000); // ✅ 1 minute
            });
        }
    </script>

</body>

</html>
